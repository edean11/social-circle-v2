#padding-fix.container-fluid
    .row
        %h2#circleHeader #{@user.name}'s Circle
    .row
        .linkWedgeTopLeft
            = link_to "", new_cast_path, class: "fa fa-rss", id: 'castIconLink'
        .linkWedgeTopRight
            = link_to "", new_group_path, class: "fa fa-users", id: 'groupIconLink'
        .linkWedgeBottomLeft
            = link_to "", new_subscription_path, class: "fa fa-bookmark", id: 'subscriptionIconLink'
        #map.col-sm-7
        .sidebarContainer.col-sm-5
            .groupsContainer
            .commentArea.hidden
                %button#closeComments Close
                .commentsContainer
                    .castCommentsHeader
                    .castComments
                .commentInputContainer
                    %input#commentInput
                    %button#submitComment Submit
            .searchArea
                %p Search
                %select#searchType
                    %option Title
                    %option Content
                    %option User
                %input.searchInput
                %button.submitSearch{:type => "button"} Submit

:javascript

    //Holder variables
    var markers = [];
    var infoWindows = [];
    var mapArr = [];
    var userName = "#{@user.name}"
    var userId = "#{@user.id}"
    var openCastId = [];
    var lastRefreshCastIds = [];
    var lastUsedPath = [];



    //////////////////////////////////////////////
    //////////////// MARKERS /////////////////////
    //////////////////////////////////////////////

    //Create marker icon
    function createIcon(pinColor){
        var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
        new google.maps.Size(21, 34),
        new google.maps.Point(0,0),
        new google.maps.Point(10, 34));
        return pinImage;
    }

    //Marker functions
    function populateMarker(position,map,infowindow,cast_id,color) {
        var pinImage = createIcon(color);
        var marker = new google.maps.Marker({
          position: position,
          map: map,
          icon: pinImage,
          animation: google.maps.Animation.DROP
        });
        marker.set("id", cast_id);
        map.panTo(position);
        google.maps.event.addListener(marker, 'click', function(e) {
          closeAllInfoWindows();
          infowindow.open(map,marker);
          showComments(marker.id);
        });
        markers.push(marker);
    }
    function deleteMarker(cast_id){
        $.ajax({
          url: "/casts/" + cast_id,
          type: "post",
          dataType: "json",
          data: {"_method":"delete"}
        });
    }
    function removeAllMarkersFromMap(){
        for(var i=0;i<markers.length;i++){
            markers[i].setMap(null);
            markers[i] = null;
        }
        markers = [];
    }
    function closeAllInfoWindows() {
        for (var i=0;i<infoWindows.length;i++) {
          infoWindows[i].close();
        }
    }
    function findDaysLeft(expiration){
        var now = new Date();
        var exp = Date.parse(expiration);
        var daysleft = parseFloat(((exp - now)/1000)*(1/86400)).toFixed(2);
        return daysleft;
    }

    function findMarkerColor(expiration){
        var daysleft = findDaysLeft(expiration);
        var color;
        if(daysleft<0){
            color = 'expired'
        }else if(daysleft<0.05){
            color = 'FA334F'
        }else if(daysleft<1){
            color = 'FFD700'
        }else if(daysleft<7){
            color = '96D72D'
        }else if(daysleft<30){
            color = '323299'
        }else if(daysleft<365){
            color = '70018B'
        }
        return color;
    }

    function makeInfoWindow(cast){
        //add content to each infowindow
        var contentString = '<div class="castPopup '+cast.id+'Popup" id="cast.id">'+
                '<p class=castTitle '+cast.id+'Title>'+cast.title+'</p>'+
                '<p class=castContent '+cast.id+'Content>'+cast.content+'</p>'+
                "<p class=castExpiration "+cast.id+"Expiration>"+findDaysLeft(cast.expiration)+" Days Left</p>"
                '</div>'
        var infowindow = new google.maps.InfoWindow({
            content: contentString
        });
        //populate variable array for reference
        infoWindows.push(infowindow);
        return infowindow;
    }

    function populateMarkers(path,map){
        $.getJSON(path,function(data) {
          lastUsedPath = [];
          lastUsedPath.push(path);
          lastRefreshCastIds = [];
          lastRefreshedCasts = [];
          lastRefreshedCasts.push(data);
          removeAllMarkersFromMap();
          //loop through all owned markers and append
          $.each(data,function(index,cast){
            //determine latLng
            var latLng = new google.maps.LatLng(cast.lat,cast.lon);
            var infowindow = makeInfoWindow(cast);
            //attach markers and info windows to map
            var color = findMarkerColor(cast.expiration);
            if(color==='expired'){
                deleteMarker(cast.id);

            }else{
                populateMarker(latLng,map,infowindow,cast.id,color);
                lastRefreshCastIds.push(cast.id);
            }
          });
      })
    }

    function updateMarkers(){
        $.getJSON(lastUsedPath[0],function(data){
            var newCastIds = [];
            //populate new casts
            $.each(data,function(index,cast){
                newCastIds.push(cast.id)
                if(lastRefreshCastIds.indexOf(cast.id)===-1){
                    //determine latLng
                    var latLng = new google.maps.LatLng(cast.lat,cast.lon);
                    var infowindow = makeInfoWindow(cast);
                    //attach markers and info windows to map
                    var color = findMarkerColor(cast.expiration);
                    populateMarker(latLng,mapArr[0],infowindow,cast.id,color);
                    lastRefreshCastIds = [];
                    lastRefreshCastIds.push(cast.id);
                }
            })
            //remove expired casts
            $.each(lastRefreshedCasts[0],function(index,cast){
                if(newCastIds.indexOf(cast.id)===-1){
                    deleteMarker(cast.id);
                }
            })
        })
    }

    //////////////////////////////////////////////
    //////////////// COMMENTS ////////////////////
    //////////////////////////////////////////////


    function populateComments(path,is_parent){
        $.getJSON(path,function(data){
            if(is_parent){
                var elem = $('<div class="castComment" data-uuid="'+data.id+'">'+
                        '<p class="castCommentParentHeader">'+data.title+'</p>'+
                        '<p class="castCommentParentContent">'+data.content+'</p>'+
                        '<p class="castCommentParentUser">'+data.user.name+'</p>'+
                        '<p class="castCommentParentExpiration">'+findDaysLeft(data.expiration)+
                            ' Days Remaining</p>'+
                        '</div>');
                $('.commentsContainer').append(elem);
            }else{
                if(Object.keys(data).length>0){
                    $.each(data,function(index,val){
                        var elem = $('<div class="castComment" data-uuid="'+val.id+'">'+
                            '<p class="castCommentChildContent">'+val.content+'</p>'+
                            '<p class="castCommentChildUser">'+val.user.name+'</p>'+
                            '</div>');
                        $('.commentsContainer').append(elem);
                    })
                }
            }
        });
    }

    function resetCommentContainer(){
        $('.commentsContainer').empty()
        $('#commentInput').val('');
    }

    function showComments(cast_id){
        openCastId = [];
        openCastId.push(cast_id);
        resetCommentContainer();
        $('.commentArea').removeClass('hidden');
        var castPath = "#{root_url}/casts/"+cast_id;
        var commentsPath = "#{root_url}/casts/"+cast_id+"/comments"
        populateComments(castPath,true);
        populateComments(commentsPath,false);
    }

    $('#closeComments').click(function(){
        $('.commentArea').addClass('hidden');
    });

    function postComment(cast_ID){
        var commentVal = $('#commentInput').val();
        if(commentVal!==''){
            $.post("#{comments_path}", { content: commentVal, user_id: "#{current_user}", cast_id: cast_ID },
                function(data){
                    console.log('posted:'+data);
                },'json');
        }else{
            console.log("Please enter a comment in order to submit");
        }
    }

    $('#submitComment').click(function(){
        console.log(openCastId[0]);
        if(openCastId[0]){
            var castPath = "#{root_url}/casts/"+openCastId[0];
            var commentsPath = "#{root_url}/casts/"+openCastId[0]+"/comments"
            postComment(openCastId[0]);
            resetCommentContainer();
            populateComments(castPath,true);
            populateComments(commentsPath,false);
        }
    })

    /////////////////////////////////////////////
    //////////////// SEARCH /////////////////////
    /////////////////////////////////////////////

    function searchCasts(){
        var selectedType = $('#searchType option:selected').text();
        var searchVal = $('.searchInput').val();
        $('#circleHeader').text(searchVal+" Casts");
        if(selectedType==='Title'){
            populateMarkers("#{root_url}/casts.json?search_title="+searchVal,mapArr[0]);
        }else if(selectedType==='Content'){
            populateMarkers("#{root_url}/casts.json?search_content="+searchVal,mapArr[0]);
        }else if(selectedType==='Users'){
            populateMarkers("#{root_url}/casts.json?search_user="+searchVal,mapArr[0]);
        }else{console.log('invalid search')}
    }

    $('.submitSearch').click(function(){
        searchCasts();
        $('.searchInput').val('');
    })

    //////////////////////////////////////////////
    //////////////// INITIALIZE //////////////////
    //////////////////////////////////////////////

    function populateSubscribedGroups(){
        var myCastsElem = $('<div class="groupContainer" data-uuid="'+userId+'"><p class="groupName">'+
                "#{@user.name}"+'</p></div>')
        $('.groupsContainer').append(myCastsElem);
        $.getJSON("#{user_groups_path(@user)}",function(data) {
            $.each(data,function(index,group){
                var elem = $('<div class="groupContainer" data-uuid="'+group.id+'"><p class="groupName">'+
                group.name+'</p></div>')
                $('.groupsContainer').append(elem);
            });
        });
    }

    function initialize() {
      if(!($('#map').length)){return}
      //insert rails variables here
      var mapOptions = {
        center: { lat: parseFloat(-25.363882), lng: parseFloat(131.044922)},
        zoom: 8,
        disableDefaultUI: true
      };
      var map = new google.maps.Map(document.getElementById('map'),
        mapOptions);
      mapArr.push(map);
      populateMarkers("#{user_casts_path(@user)}",map)
      var refreshCastInterval = setInterval(updateMarkers,5000);
      populateSubscribedGroups();
      $('.groupsContainer').click('.groupContainer',function(e){
        if($(e.target).attr('data-uuid')){
            var groupName = $(e.target).children()[0].innerHTML;
            if(groupName===userName){
                $('#circleHeader').text(groupName+"'s Circle");
                populateMarkers("#{root_url}/users/"+$(e.target).attr('data-uuid')+"/casts.json",mapArr[0]);
            }else{
                $('#circleHeader').text(groupName+" Circle");
                populateMarkers("#{root_url}/groups/"+$(e.target).attr('data-uuid')+"/casts.json",mapArr[0]);
            }
        }
      })
    }
    google.maps.event.addDomListener(window, 'load', initialize);


